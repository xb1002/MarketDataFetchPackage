# MarketDataFetchPackage 代码规范

本规范汇总了当前主流 Python 库开发的最佳实践，并结合加密货币市场数据采集场景的特殊需求制定。所有贡献者在开始编码、编写文档或测试之前都应通读本文件。

## 1. 通用原则
- **优先保证可读性和一致性。** 当存在多种可行写法时，选择最清晰、最易维护的方案。
- **最小化耦合，隔离外部依赖。** 所有与交易所、网络或磁盘交互的逻辑要通过可替换的接口或适配层暴露，方便测试。
- **面向失败进行设计。** 明确处理网络抖动、速率限制和数据缺失，所有对外 API 必须有可预测的异常类型。
- **尽量无副作用。** 模块入口仅在 `if __name__ == "__main__":` 中执行命令行逻辑，其余文件仅定义函数、类或常量。
- **遵循 SOLID 面向对象设计准则。**
  - **S（单一职责）**：每个类或模块只负责一个聚焦的功能。获取行情、解析数据、持久化等职责需分离；若类难以描述其目的说明职责过多。
  - **O（开放封闭）**：对扩展开放、对修改封闭。新增交易所或数据类型应通过实现公共接口、注册表或插件扩展，而非修改现有核心逻辑。
  - **L（里氏替换）**：派生类必须能够在不改变行为的前提下替代基类。例如所有 `ExchangeClient` 实现都必须遵守统一的异常、返回值和超时约定。
  - **I（接口隔离）**：优先提供粒度合理的小接口。对上层暴露的抽象不应强制实现无关方法，可使用多个 mixin/协议区分行情、交易、订阅等能力。
  - **D（依赖反转）**：高层模块依赖抽象而非具体实现。通过构造函数注入 HTTP 客户端、缓存或限流器，便于在测试时替换 mock。

## 2. 代码组织
- 包的根目录使用小写加下划线命名，例如 `market_data_fetch`。
- 每个交易所的实现位于 `exchanges/<exchange_name>.py` 模块中，并实现统一的 `ExchangeClient` 抽象（例如 `fetch_order_book`, `fetch_trades`, `fetch_klines`）。
- 公共模型（数据类、枚举）集中在 `models/`，配置和常量放在 `config/`。
- 把 HTTP/WebSocket 等传输逻辑与业务解析逻辑分离；解析逻辑应可独立单元测试。
- 保持模块深度 <= 4 层，超过时需要重新划分。

## 3. Python 风格要求
- 遵循 [PEP 8] 和 [PEP 257]。通过 `ruff` 或 `flake8` + `black` 自动化检查，行宽 100 列。
- 必须使用类型标注（PEP 484/PEP 561），并在 CI 中运行 `mypy`（`--strict` 优先）。
- 变量、函数使用蛇形命名；类名使用帕斯卡命名；常量全部大写。
- 不得使用通配符导入 (`from module import *`)；导入顺序：标准库、三方库、本地包，块与块之间空一行。
- 避免全局可变状态。若必须存在（如缓存），务必通过线程安全结构或显式锁控制。
- 日志使用 `logging` 标准库，并在 `config/logging.py` 中集中初始化。严禁 `print` 调试留在提交里。

## 4. 文档与注释
- 对外 API、公共类、复杂函数必须提供 Google 或 NumPy 风格 docstring，包含参数、返回值、异常和示例。
- 若算法或业务规则难以直接从代码推断，必须在邻近位置提供块注释阐明背景。
- README 和 `docs/` 目录应涵盖：包简介、支持的交易所列表、安装方法、基本用法、贡献指南。
- 在新增功能时，同步更新相关文档和示例。

## 5. 错误处理与数据验证
- 所有网络请求在单处封装重试、退避与速率限制策略。
- 对来自交易所的数据执行结构/字段验证（可使用 `pydantic`/`dataclasses`），确保类型一致。
- 自定义异常继承自 `MarketDataError`，并区分：`NetworkError`、`RateLimitError`、`ParsingError`、`ExchangeUnsupportedError` 等。
- 日志中包含请求 ID、交易所、端点、状态码等关键信息。

## 6. 测试与质量保障
- 单元测试覆盖率≥80%，对关键解析逻辑和时间序列处理需提供边界用例。
- 使用 pytest，测试文件与模块结构保持一致（`tests/exchanges/test_binance.py`）。
- 网络交互需使用 `responses`、`pytest-httpserver` 或自建 fixture 模拟，禁止直接访问真实交易所接口。
- 在合并前运行：`ruff check .`、`black --check .`、`mypy .`、`pytest`。

## 7. Git 与协作
- 遵循 conventional commits（如 `feat: add binance klines client`）。
- 每个 PR 只处理单一主题；确保描述包含动机、方案和测试结果。
- 禁止在主分支提交未通过测试或不符合规范的代码。

> 若本规范与更具体的模块规范冲突，以更细粒度文档为准。随着项目演进请及时修订此文件。
